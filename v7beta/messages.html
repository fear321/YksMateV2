<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YKSMate - Mesajlar</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="assets/images/logo(192).png">
    
    <style>
        .chat-container {
            max-height: 70vh;
            min-height: 70vh;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* Mesajlaşma sayfası düzeni */
        .messages-container {
            display: flex;
            gap: 20px;
            max-height: 70vh;
            min-height: 70vh;
        }
        
        /* Arkadaş listesi stilleri */
        .friends-list-container {
            width: 30%;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .friends-list-header {
            padding: 15px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .friends-list-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }
        
        .friends-search {
            padding: 10px 15px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        
        .friends-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }
        
        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .friend-item:hover {
            background-color: #f5f5f5;
        }
        
        .friend-item.active {
            background-color: #e6f0ff;
            border-left: 3px solid #4a6cf7;
        }
        
        .friend-avatar {
            background-color: #4a6cf7;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: 600;
            margin: 0 0 3px 0;
            font-size: 0.95rem;
        }
        
        .friend-status {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .friend-status i {
            margin-right: 5px;
            font-size: 0.7rem;
        }
        
        .last-message {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .unread-badge {
            background-color: #4a6cf7;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        /* Mesajlaşma alanı stilleri */
        .chat-area-container {
            flex: 1;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .chat-header h3 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }
        
        .clear-chat-btn {
            padding: 5px 10px;
            font-size: 0.85rem;
            background-color: transparent;
            border: 1px solid #dc3545;
            color: #dc3545;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .clear-chat-btn:hover {
            background-color: #dc3545;
            color: white;
        }
        
        .clear-chat-btn i {
            font-size: 0.8rem;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scroll-behavior: smooth;
            width: 100%;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        
        .chat-input textarea {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
            font-family: 'Poppins', sans-serif;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: normal;
            word-break: normal;
            line-height: 1.5;
            font-size: 1rem;
            overflow-wrap: break-word;
            text-rendering: optimizeLegibility;
        }
        
        .chat-input button {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        
        .chat-input button:hover {
            background-color: #3a5ce5;
        }
        
        /* Mesaj stilleri */
        .user-message, .friend-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            width: 100%;
        }
        
        .user-message {
            justify-content: flex-end;
            width: 100%;
            text-align: right;
        }
        
        .user-message .message-content {
            background-color: #4a6cf7;
            color: white;
            border-radius: 18px 18px 0 18px;
            padding: 10px 15px;
            max-width: 85%;
            min-width: 60px;
            word-wrap: normal;
            word-break: normal;
            white-space: normal;
            display: inline-block;
            text-align: right;
            hyphens: none;
            overflow-wrap: break-word;
            box-sizing: border-box;
            width: auto;
            letter-spacing: normal;
            margin-left: auto;
        }
        
        .user-message .message-content p {
            text-align: right;
        }
        
        .friend-message .message-content {
            background-color: #f1f1f1;
            border-radius: 18px 18px 18px 0;
            padding: 10px 15px;
            max-width: 85%;
            min-width: 60px;
            word-wrap: normal;
            word-break: normal;
            white-space: normal;
            display: block;
            text-align: left;
            hyphens: none;
            overflow-wrap: break-word;
            box-sizing: border-box;
            width: auto;
            letter-spacing: normal;
        }
        
        .message-content p {
            margin: 0;
            padding: 0;
            line-height: 1.5;
            white-space: normal;
            word-break: normal;
            overflow-wrap: break-word;
            hyphens: none;
            text-align: left;
            width: 100%;
            letter-spacing: normal;
            font-kerning: normal;
            font-variant-ligatures: normal;
        }
            
        .friend-avatar {
            background-color: #4a6cf7;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }
        
        /* Temizle butonu */
        .clear-chat-btn {
            margin-top: 0;
            align-self: center;
        }
        
        /* Karanlık tema uyumluluğu */
        .dark-theme .friends-list-container,
        .dark-theme .chat-area-container {
            background-color: #2a2a2a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .dark-theme .friends-list-header,
        .dark-theme .friends-search,
        .dark-theme .chat-header {
            background-color: #333;
            border-bottom: 1px solid #444;
        }
        
        .dark-theme .friends-list-header h3,
        .dark-theme .chat-header h3 {
            color: #eee;
        }
        
        .dark-theme .friends-search input {
            background-color: #444;
            border-color: #555;
            color: #eee;
        }
        
        .dark-theme .friend-item:hover {
            background-color: #3a3a3a;
        }
        
        .dark-theme .friend-item.active {
            background-color: #2c3a5a;
            border-left: 3px solid #4a6cf7;
        }
        
        .dark-theme .friend-name {
            color: #eee;
        }
        
        .dark-theme .friend-status,
        .dark-theme .last-message {
            color: #aaa;
        }
        
        .dark-theme .chat-input {
            border-top: 1px solid #444;
            background-color: #333;
        }
        
        .dark-theme .chat-input textarea {
            background-color: #444;
            border-color: #555;
            color: #eee;
        }
        
        .dark-theme .friend-message .message-content {
            background-color: #444;
            color: #eee;
        }
        
        .dark-theme .no-messages-info p {
            color: #aaa;
        }
        
        .no-friends-info,
        .no-messages-info {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .dark-theme .no-friends-info {
            color: #aaa;
        }
        
        /* Mobil görünüm için stil düzenlemeleri */
        @media (max-width: 992px) {
            .messages-container {
                position: relative;
                overflow: hidden;
            }
            
            .friends-list-container {
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 2;
                transition: transform 0.3s ease;
                transform: translateX(0);
            }
            
            .chat-area-container {
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 1;
                transition: transform 0.3s ease;
                transform: translateX(100%);
            }
            
            .show-chat .friends-list-container {
                transform: translateX(-100%);
            }
            
            .show-chat .chat-area-container {
                transform: translateX(0);
            }
            
            .back-button {
                display: flex;
                align-items: center;
                gap: 5px;
                background: none;
                border: none;
                color: #4a6cf7;
                cursor: pointer;
                font-size: 1rem;
                padding: 0;
                margin-right: 10px;
            }
            
            .back-button i {
                font-size: 1.2rem;
            }
            
            .chat-header {
                display: flex;
                align-items: center;
            }
            
            .chat-header h3 {
                flex: 1;
            }
        }
        
        @media (min-width: 993px) {
            .back-button {
                display: none;
            }
        }
    </style>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Ana JavaScript -->
    <script src="js/firebase-config.js"></script>
    <script src="js/auth-check.js"></script>
    <script src="js/theme-manager.js"></script>
    <script src="js/app.js"></script>

</head>
<body class="light-theme">
    <div class="container">
        <div class="dashboard-container" id="dashboardContainer" style="display: none;">
            <!-- Sidebar -->
            <div class="sidebar">

                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <a href="profile.html" style="text-decoration: none; color: inherit;">
                            <h3 id="userName">Kullanıcı Adı</h3>
                            <p id="userExamType">Bölüm: TYT</p>
                        </a>
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <ul>
                        <li>
                            <a href="index.html"><i class="fas fa-home"></i> Ana Sayfa</a>
                        </li>
                        <li>
                            <a href="exams.html"><i class="fas fa-file-alt"></i> Denemelerim</a>
                        </li>
                        <li>
                            <a href="timer.html"><i class="fas fa-clock"></i> Zamanlayıcı</a>
                        </li>
                        <li>
                            <a href="calendar.html"><i class="fas fa-calendar-alt"></i> Takvim</a>
                        </li>
                        <li>
                            <a href="notes.html"><i class="fas fa-sticky-note"></i> Notlarım</a>
                        </li>
                        <li>
                            <a href="community.html"><i class="fas fa-users"></i> Topluluk</a>
                        </li>
                        <li>
                            <a href="friends.html"><i class="fas fa-user-friends"></i> Arkadaşlarım</a>
                        </li>
                        <li class="active">
                            <a href="messages.html"><i class="fas fa-comment"></i> Mesajlar</a>
                        </li>
                        <li>
                            <a href="profile.html"><i class="fas fa-user-circle"></i> Profil</a>
                        </li>
                        <li>
                            <a href="settings.html"><i class="fas fa-cog"></i> Ayarlar</a>
                        </li>
                    </ul>
                </nav>
                <div class="sidebar-footer">
                    <button id="collapseToggle" class="collapse-toggle">
                        <i class="fas fa-chevron-left"></i>
                        <span>Menüyü Daralt</span>
                    </button>
                    <button id="logoutBtn" class="btn btn-outline">
                        <i class="fas fa-sign-out-alt"></i> <span>Çıkış Yap</span>
                    </button>
                </div>
            </div>

            <!-- Sidebar Overlay -->
            <div class="sidebar-overlay"></div>

            <!-- Ana İçerik -->
            <div class="main-content">
                <header class="content-header">
                    <button id="sidebarToggle" class="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Ara...">
                    </div>
                    <div class="header-actions">
                        <button class="theme-toggle" id="themeToggle">
                            <i class="fas fa-moon"></i>
                        </button>
                        <div class="notifications">
                            <button class="notification-btn">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge">3</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Mesajlar Sayfa İçeriği -->
                <div class="page-content">
                    <div class="messages-page">
                        <h1 class="page-title">Mesajlar</h1>
                        
                        <!-- Mesajlaşma Alanı -->
                        <div class="messages-container">
                            <!-- Arkadaş Listesi -->
                            <div class="friends-list-container">
                                <div class="friends-list-header">
                                    <h3>Arkadaşlarım</h3>
                                </div>
                                <div class="friends-search">
                                    <input type="text" id="friendSearchInput" placeholder="Arkadaş ara...">
                                </div>
                                <div class="friends-list" id="friendsList">
                                    <!-- Arkadaş listesi buraya gelecek -->
                                    <div class="no-friends-info">
                                        <p>Henüz arkadaşınız bulunmuyor. Arkadaşlar sayfasından arkadaş ekleyebilirsiniz.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mesajlaşma Alanı -->
                            <div class="chat-area-container">
                                <div class="chat-header">
                                    <button class="back-button" id="backToFriendsList">
                                        <i class="fas fa-arrow-left"></i> Geri
                                    </button>
                                    <h3 id="chatFriendName">Arkadaş Seçin</h3>
                                    <button id="clearChatBtn" class="btn btn-outline clear-chat-btn">
                                        <i class="fas fa-trash"></i> Sohbeti Temizle
                                    </button>
                                </div>
                                <div class="chat-messages" id="chatMessages">
                                    <!-- Mesajlar buraya gelecek -->
                                    <div class="no-messages-info">
                                        <p>Mesajlaşmak için sol taraftan bir arkadaş seçin veya arkadaşlar sayfasından yeni arkadaşlar ekleyin.</p>
                                    </div>
                                </div>
                                
                                <!-- Mesaj Gönderme Alanı -->
                                <div class="chat-input">
                                    <textarea id="messageInput" placeholder="Mesajınızı yazın..." rows="1" disabled></textarea>
                                    <button id="sendMessageBtn" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Mesajlar sayfası yüklendi");
            
            // Firebase bağlantısını kontrol et
            if (typeof firebase === 'undefined') {
                console.error("Firebase tanımlı değil!");
                alert("Firebase bağlantısı kurulamadı. Lütfen sayfayı yenileyin.");
                return;
            }
            
            console.log("Firebase bağlantısı kontrol ediliyor...");
            
            // Firebase yapılandırmasını kontrol et
            try {
                const app = firebase.app();
                console.log("Firebase uygulaması başarıyla başlatıldı:", app.name);
                
                // Veritabanı bağlantısını test et
                firebase.database().ref('.info/connected').on('value', function(snapshot) {
                    if (snapshot.val() === true) {
                        console.log("Firebase veritabanına bağlantı başarılı");
                    } else {
                        console.warn("Firebase veritabanına bağlantı beklemede");
                    }
                });
            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                alert("Firebase bağlantısı sırasında bir hata oluştu: " + error.message);
                return;
            }
            
            // Oturum kontrolü
            if (typeof firebase !== 'undefined' && firebase.app) {
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        console.log("Kullanıcı oturum açmış:", user.uid);
                        
                        // Kullanıcı bilgilerini güncelle
                        firebase.database().ref('users/' + user.uid).once('value')
                            .then((snapshot) => {
                                const userData = snapshot.val();
                                console.log("Kullanıcı verileri yüklendi:", userData);
                                
                                if (userData) {
                                    document.getElementById("userName").textContent = userData.name || user.email.split('@')[0];
                                    document.getElementById("userExamType").textContent = "Bölüm: " + getExamTypeText(userData.examType);
                                } else {
                                    console.warn("Kullanıcı verileri bulunamadı");
                                }
                                
                                document.getElementById("dashboardContainer").style.display = "flex";
                                
                                // URL'den arkadaş ID'sini al
                                const urlParams = new URLSearchParams(window.location.search);
                                const friendId = urlParams.get('friend');
                                
                                // Arkadaş listesini her zaman yükle
                                loadFriendsList(user.uid);
                                
                                // Yeni mesajları dinle
                                listenForNewMessages(user.uid);
                                
                                // Her saniyede bir son mesajları güncelle
                                startLastMessageRefresher(user.uid);
                                
                                if (friendId) {
                                    // Arkadaş bilgilerini yükle ve sohbeti başlat
                                    loadFriendInfo(friendId);
                                    
                                    // Mobil görünümde mesaj alanını göster
                                    if (window.innerWidth <= 992) {
                                        document.querySelector('.messages-container').classList.add('show-chat');
                                    }
                                }
                                
                                // Geri tuşuna tıklama olayını ekle
                                document.getElementById('backToFriendsList').addEventListener('click', function() {
                                    // Mesaj alanını gizle
                                    document.querySelector('.messages-container').classList.remove('show-chat');
                                    
                                    // URL'den friend parametresini kaldır
                                    const newUrl = window.location.pathname;
                                    window.history.pushState({}, '', newUrl);
                                    
                                    // Aktif arkadaş seçimini kaldır
                                    document.querySelectorAll('.friend-item').forEach(item => {
                                        item.classList.remove('active');
                                    });
                                    
                                    // Mesaj alanını sıfırla
                                    document.getElementById('chatFriendName').textContent = 'Arkadaş Seçin';
                                    document.getElementById('messageInput').disabled = true;
                                    document.getElementById('sendMessageBtn').disabled = true;
                                    document.getElementById('chatMessages').innerHTML = '<div class="no-messages-info"><p>Mesajlaşmak için sol taraftan bir arkadaş seçin veya arkadaşlar sayfasından yeni arkadaşlar ekleyin.</p></div>';
                                    
                                    // Mevcut arkadaş ID'sini sıfırla
                                    currentFriendId = null;
                                });
                                
                                // Pencere boyutu değiştiğinde görünümü ayarla
                                window.addEventListener('resize', function() {
                                    const messagesContainer = document.querySelector('.messages-container');
                                    const activeFriend = document.querySelector('.friend-item.active');
                                    
                                    if (window.innerWidth > 992) {
                                        // Desktop görünümünde her zaman her iki alanı da göster
                                        messagesContainer.classList.remove('show-chat');
                                    } else if (activeFriend && !messagesContainer.classList.contains('show-chat')) {
                                        // Mobil görünümde aktif bir arkadaş varsa ve mesaj alanı gizliyse göster
                                        messagesContainer.classList.add('show-chat');
                                    }
                                });
                                
                                // Tarayıcının geri tuşuna basıldığında URL'yi kontrol et
                                window.addEventListener('popstate', function(event) {
                                    // URL'den friend parametresini kontrol et
                                    const urlParams = new URLSearchParams(window.location.search);
                                    const friendId = urlParams.get('friend');
                                    
                                    if (!friendId) {
                                        // Friend parametresi yoksa arkadaş listesini göster
                                        document.querySelector('.messages-container').classList.remove('show-chat');
                                        
                                        // Aktif arkadaş seçimini kaldır
                                        document.querySelectorAll('.friend-item').forEach(item => {
                                            item.classList.remove('active');
                                        });
                                        
                                        // Mesaj alanını sıfırla
                                        document.getElementById('chatFriendName').textContent = 'Arkadaş Seçin';
                                        document.getElementById('messageInput').disabled = true;
                                        document.getElementById('sendMessageBtn').disabled = true;
                                        document.getElementById('chatMessages').innerHTML = '<div class="no-messages-info"><p>Mesajlaşmak için sol taraftan bir arkadaş seçin veya arkadaşlar sayfasından yeni arkadaşlar ekleyin.</p></div>';
                                        
                                        // Mevcut arkadaş ID'sini sıfırla
                                        currentFriendId = null;
                                    } else {
                                        // Friend parametresi varsa o arkadaşın mesajlarını göster
                                        const friendItem = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
                                        if (friendItem) {
                                            // Aktif sınıfını diğer öğelerden kaldır
                                            document.querySelectorAll('.friend-item').forEach(item => {
                                                item.classList.remove('active');
                                            });
                                            
                                            // Bu öğeye aktif sınıfını ekle
                                            friendItem.classList.add('active');
                                            
                                            // Arkadaş bilgilerini yükle ve sohbeti başlat
                                            loadFriendInfo(friendId);
                                            
                                            // Mobil görünümde mesaj alanını göster
                                            if (window.innerWidth <= 992) {
                                                document.querySelector('.messages-container').classList.add('show-chat');
                                            }
                                        }
                                    }
                                });
                            })
                            .catch(error => {
                                console.error("Kullanıcı bilgileri yüklenirken hata:", error);
                            });
                    } else {
                        console.log("Kullanıcı oturum açmamış, giriş sayfasına yönlendiriliyor");
                        window.location.href = "login.html";
                    }
                });
            } else {
                console.error("Firebase tanımlı değil");
                alert("Firebase bağlantısı kurulamadı. Lütfen sayfayı yenileyin.");
            }
            
            // Arkadaş listesini yükleme
            function loadFriendsList(userId) {
                console.log("Arkadaş listesi yükleniyor, kullanıcı ID:", userId);
                
                const friendsList = document.getElementById('friendsList');
                friendsList.innerHTML = '<div class="no-friends-info"><p>Arkadaşlar yükleniyor...</p></div>'; // Yükleniyor mesajı
                
                // Firebase'den kullanıcı bilgilerini ve arkadaş listesini çek
                firebase.database().ref('users/' + userId).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        console.log("Kullanıcı verileri:", userData);
                        
                        if (!userData || !userData.friends || Object.keys(userData.friends).length === 0) {
                            console.log("Arkadaş bulunamadı");
                            friendsList.innerHTML = '<div class="no-friends-info"><p>Henüz arkadaşınız bulunmuyor. Arkadaşlar sayfasından arkadaş ekleyebilirsiniz.</p></div>';
                            return;
                        }
                        
                        console.log("Arkadaş listesi:", userData.friends);
                        
                        // Listeyi temizle
                        friendsList.innerHTML = '';
                        
                        // Her bir arkadaş için bilgileri listele
                        Object.keys(userData.friends).forEach(friendId => {
                            const friendData = userData.friends[friendId];
                            console.log("Arkadaş ID:", friendId, "Arkadaş verileri:", friendData);
                            
                            // Arkadaş verilerini kontrol et
                            if (!friendData) {
                                console.error("Arkadaş verileri bulunamadı:", friendId);
                                return;
                            }
                            
                            // Basit bir arkadaş öğesi oluştur
                            const friendItem = document.createElement('div');
                            friendItem.className = 'friend-item';
                            friendItem.dataset.friendId = friendId;
                            
                            // URL'den gelen arkadaş ID'si ile eşleşiyorsa aktif olarak işaretle
                            const urlParams = new URLSearchParams(window.location.search);
                            const urlFriendId = urlParams.get('friend');
                            if (urlFriendId === friendId) {
                                friendItem.classList.add('active');
                            }
                            
                            // Başlangıçta durum bilgisini yükleniyor olarak göster
                            friendItem.innerHTML = `
                                <div class="friend-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="friend-info">
                                    <h4 class="friend-name">${friendData.name || 'İsimsiz Kullanıcı'}</h4>
                                    <p class="friend-status"><i class="fas fa-circle" style="color: #6c757d;"></i> Durum yükleniyor...</p>
                                </div>
                            `;
                            
                            // Arkadaş öğesine tıklama olayı ekle
                            friendItem.addEventListener('click', function() {
                                // Aktif sınıfını diğer öğelerden kaldır
                                document.querySelectorAll('.friend-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                // Bu öğeye aktif sınıfını ekle
                                this.classList.add('active');
                                
                                // Arkadaş ID'sini al
                                const friendId = this.getAttribute('data-friend-id');
                                
                                // Arkadaş bilgilerini yükle ve sohbeti başlat
                                loadFriendInfo(friendId);
                                
                                // URL'yi güncelle (sayfa yenilenmeden)
                                window.history.pushState({}, '', `?friend=${friendId}`);
                                
                                // Mobil görünümde mesaj alanını göster
                                if (window.innerWidth <= 992) {
                                    document.querySelector('.messages-container').classList.add('show-chat');
                                }
                            });
                            
                            friendsList.appendChild(friendItem);
                            
                            // Arkadaşın çevrimiçi durumunu kontrol et
                            firebase.database().ref('status/' + friendId).once('value')
                                .then((statusSnapshot) => {
                                    const statusData = statusSnapshot.val();
                                    const isOnline = statusData && statusData.state === 'online';
                                    const lastActivity = statusData ? statusData.lastActivity : null;
                                    
                                    // Çevrimiçi durumu ve aktivite bilgisini hazırla
                                    let statusText = '';
                                    let statusColor = '';
                                    
                                    if (isOnline) {
                                        statusText = 'Çevrimiçi';
                                        statusColor = '#28a745';
                                    } else {
                                        statusText = 'Çevrimdışı';
                                        statusColor = '#6c757d';
                                        if (lastActivity) {
                                            const lastSeen = new Date(lastActivity);
                                            const now = new Date();
                                            const diffHours = Math.floor((now - lastSeen) / (1000 * 60 * 60));
                                            
                                            if (diffHours < 1) {
                                                statusText += ' - Az önce';
                                            } else if (diffHours < 24) {
                                                statusText += ` - ${diffHours} saat önce`;
                                            } else {
                                                const diffDays = Math.floor(diffHours / 24);
                                                statusText += ` - ${diffDays} gün önce`;
                                            }
                                        }
                                    }
                                    
                                    // Durum bilgisini güncelle
                                    const statusElement = friendItem.querySelector('.friend-status');
                                    if (statusElement) {
                                        statusElement.innerHTML = `<i class="fas fa-circle" style="color: ${statusColor};"></i> ${statusText}`;
                                    }
                                })
                                .catch(error => {
                                    console.error("Arkadaş durumu yüklenirken hata:", error);
                                });
                            
                            // Son mesaj bilgisini kontrol et
                            const chatId = [userId, friendId].sort().join('_');
                            
                            // Doğrudan mesajlardan son mesajı bul
                            firebase.database().ref('messages/' + chatId)
                                .orderByChild('timestamp')
                                .limitToLast(1)
                                .once('value')
                                .then((messageSnapshot) => {
                                    if (messageSnapshot.exists()) {
                                        let lastMessage = null;
                                        
                                        messageSnapshot.forEach((childSnapshot) => {
                                            lastMessage = childSnapshot.val();
                                        });
                                        
                                        if (lastMessage) {
                                            // Mesajı deşifre et
                                            let messageContent = lastMessage.content;
                                            if (lastMessage.type === 'encrypted') {
                                                try {
                                                    messageContent = atob(lastMessage.content); // Base64 decoding
                                                } catch (error) {
                                                    console.error("Mesaj deşifre edilirken hata:", error);
                                                    messageContent = "Mesaj okunamadı";
                                                }
                                            }
                                            
                                            // Son mesaj bilgisini ekle
                                            const friendInfo = friendItem.querySelector('.friend-info');
                                            if (friendInfo) {
                                                friendInfo.insertAdjacentHTML('beforeend', `<p class="last-message">${messageContent}</p>`);
                                            }
                                            
                                            // Okunmamış mesaj sayısını hesaplama ve güncelleme
                                            updateUnreadMessageCount(chatId, friendId, userId);
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error("Son mesaj bilgisi yüklenirken hata:", error);
                                });
                        });
                    })
                    .catch(error => {
                        console.error("Arkadaş listesi yüklenirken hata:", error);
                        friendsList.innerHTML = '<div class="no-friends-info"><p>Arkadaş listesi yüklenirken bir hata oluştu.</p></div>';
                    });
            }
            
            // Arkadaş bilgilerini yükleme
            window.loadFriendInfo = function(friendId) {
                firebase.database().ref('users/' + friendId).once('value')
                    .then((snapshot) => {
                        const friendData = snapshot.val();
                        if (friendData) {
                            // Arkadaş bilgilerini göster
                            document.getElementById('chatFriendName').textContent = friendData.name || 'Arkadaş';
                            
                            // Mesaj gönderme alanını etkinleştir
                            document.getElementById('messageInput').disabled = false;
                            document.getElementById('sendMessageBtn').disabled = false;
                            
                            // Sohbet geçmişini yükle
                            loadChatHistory(friendId);
                            
                            // Okunmamış mesajları okundu olarak işaretle
                            markMessagesAsRead(friendId);
                            
                            // Arkadaş listesindeki okunmamış mesaj sayısını güncelle
                            updateUnreadBadge(friendId, 0);
                        } else {
                            console.error("Arkadaş bilgileri bulunamadı");
                        }
                    })
                    .catch(error => {
                        console.error("Arkadaş bilgileri yüklenirken hata:", error);
                    });
            }
            
            // Mesaj gönderme işlevi
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessageBtn');
            const chatMessages = document.getElementById('chatMessages');
            
            // Global değişkenler
            let currentFriendId = null;
            let messagesRef = null;

            // Textarea yüksekliğini otomatik ayarla
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Yeni mesajları dinleme
            function listenForNewMessages(userId) {
                console.log("Yeni mesaj dinleyicileri başlatılıyor...");
                
                // Tüm mesaj koleksiyonlarını dinle
                firebase.database().ref('messages').on('child_added', function(chatSnapshot) {
                    const chatId = chatSnapshot.key;
                    const chatParts = chatId.split('_');
                    
                    // Eğer bu sohbet kullanıcıya ait değilse, atla
                    if (!chatParts.includes(userId)) return;
                    
                    console.log("Yeni mesaj koleksiyonu algılandı:", chatId);
                    
                    // Arkadaş ID'sini bul
                    const friendId = chatParts[0] === userId ? chatParts[1] : chatParts[0];
                    
                    // Arkadaş listesini güncelle
                    updateFriendLastMessage(userId, friendId);
                });
                
                // Mesaj değişikliklerini dinle
                firebase.database().ref('messages').on('child_changed', function(chatSnapshot) {
                    const chatId = chatSnapshot.key;
                    const chatParts = chatId.split('_');
                    
                    // Eğer bu sohbet kullanıcıya ait değilse, atla
                    if (!chatParts.includes(userId)) return;
                    
                    console.log("Mesaj değişikliği algılandı:", chatId);
                    
                    // Arkadaş ID'sini bul
                    const friendId = chatParts[0] === userId ? chatParts[1] : chatParts[0];
                    
                    // Arkadaş listesini güncelle
                    updateFriendLastMessage(userId, friendId);
                    
                    // Eğer bu arkadaşla aktif bir sohbet varsa
                    if (friendId === currentFriendId) {
                        // Yeni mesajları kontrol et ve UI'a ekle
                        updateActiveChatMessages(chatId, userId, friendId);
                    }
                });
                
                // Yeni mesajları dinle
                firebase.database().ref('messages').on('child_changed', function(chatSnapshot) {
                    const chatId = chatSnapshot.key;
                    const chatParts = chatId.split('_');
                    
                    // Eğer bu sohbet kullanıcıya ait değilse, atla
                    if (!chatParts.includes(userId)) return;
                    
                    // Arkadaş ID'sini bul
                    const friendId = chatParts[0] === userId ? chatParts[1] : chatParts[0];
                    
                    // Eğer bu arkadaşla aktif bir sohbet varsa
                    if (friendId === currentFriendId) {
                        // Mesajları okundu olarak işaretle
                        markMessagesAsRead(friendId);
                    }
                });
            }
            
            // Arkadaşın son mesajını güncelle
            function updateFriendLastMessage(userId, friendId) {
                console.log("Arkadaş son mesajı güncelleniyor:", friendId);
                
                const chatId = [userId, friendId].sort().join('_');
                
                // Son mesajı bul
                firebase.database().ref('messages/' + chatId)
                    .orderByChild('timestamp')
                    .limitToLast(1)
                    .once('value')
                    .then((messageSnapshot) => {
                        if (messageSnapshot.exists()) {
                            let lastMessage = null;
                            
                            messageSnapshot.forEach((childSnapshot) => {
                                lastMessage = childSnapshot.val();
                            });
                            
                            if (lastMessage) {
                                // Mesajı deşifre et
                                let messageContent = lastMessage.content;
                                if (lastMessage.type === 'encrypted') {
                                    try {
                                        messageContent = atob(lastMessage.content); // Base64 decoding
                                    } catch (error) {
                                        console.error("Mesaj deşifre edilirken hata:", error);
                                        messageContent = "Mesaj okunamadı";
                                    }
                                }
                                
                                // Son mesajı arkadaş listesinde güncelle
                                updateLastMessageInFriendsList(friendId, messageContent);
                                
                                // Okunmamış mesaj sayısını güncelle
                                if (lastMessage.senderId === friendId && !lastMessage.read && friendId !== currentFriendId) {
                                    updateUnreadMessageCount(chatId, friendId, userId);
                                } else {
                                    // Her durumda okunmamış mesaj sayısını kontrol et
                                    updateUnreadMessageCount(chatId, friendId, userId);
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Son mesaj bilgisi yüklenirken hata:", error);
                    });
            }
            
            // Aktif sohbetteki mesajları güncelle
            function updateActiveChatMessages(chatId, userId, friendId) {
                console.log("Aktif sohbet mesajları güncelleniyor");
                
                firebase.database().ref('messages/' + chatId)
                    .orderByChild('timestamp')
                    .once('value')
                    .then((snapshot) => {
                        const messages = snapshot.val();
                        
                        if (!messages) return;
                        
                        // Mesajları temizle
                        chatMessages.innerHTML = '';
                        
                        // Mesajları ekle
                        Object.keys(messages).forEach(key => {
                            const message = messages[key];
                            const isUserMessage = message.senderId === userId;
                            
                            // Mesajı deşifre et
                            let messageContent = message.content;
                            if (message.type === 'encrypted') {
                                try {
                                    messageContent = atob(message.content); // Base64 decoding
                                } catch (error) {
                                    console.error("Mesaj deşifre edilirken hata:", error);
                                    messageContent = "Mesaj okunamadı";
                                }
                            }
                            
                            const messageHTML = isUserMessage ? 
                                `<div class="user-message" data-message-id="${key}">
                                    <div class="message-content">
                                        <p>${messageContent}</p>
                                    </div>
                                </div>` :
                                `<div class="friend-message" data-message-id="${key}">
                                    <div class="friend-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="message-content">
                                        <p>${messageContent}</p>
                                    </div>
                                </div>`;
                            
                            chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                        });
                        
                        // Sohbeti en alta kaydır
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    });
            }
            
            // Mesaj gönderme
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message && currentFriendId) {
                    // Kullanıcı ID'sini al
                    const userId = firebase.auth().currentUser.uid;
                    
                    // Mesaj alanını temizle
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    
                    // Mesajı şifrele (basit bir şifreleme)
                    const encryptedMessage = btoa(message); // Base64 encoding
                    
                    // Mesaj verilerini oluştur
                    const messageData = {
                        senderId: userId,
                        receiverId: currentFriendId,
                        content: encryptedMessage,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        read: false,
                        type: 'encrypted'
                    };
                    
                    // Sohbet ID'sini oluştur (küçük ID önce olacak şekilde)
                    const chatId = [userId, currentFriendId].sort().join('_');
                    
                    // Mesajı önce UI'a ekle (daha hızlı yanıt için)
                    const messageHTML = `
                        <div class="user-message">
                            <div class="message-content">
                                <p>${message}</p>
                            </div>
                        </div>`;
                    
                    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                    
                    // Sohbeti en alta kaydır (animasyon olmadan)
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Arkadaş listesindeki son mesajı anında güncelle
                    updateLastMessageInFriendsList(currentFriendId, message);
                    
                    // Yeni mesajı ekle
                    firebase.database().ref('messages/' + chatId).push(messageData)
                        .then((ref) => {
                            console.log("Mesaj başarıyla gönderildi, ID:", ref.key);
                            
                            // Bildirim gönder
                            sendNotification(currentFriendId, message);
                            
                            // Mesaj değişikliğini tetiklemek için özel bir güncelleme yap
                            const updateData = {};
                            updateData[ref.key + '/timestamp'] = firebase.database.ServerValue.TIMESTAMP;
                            firebase.database().ref('messages/' + chatId).update(updateData);
                        })
                        .catch(error => {
                            console.error("Mesaj gönderilirken hata:", error);
                            alert("Mesaj gönderilemedi. Lütfen tekrar deneyin.");
                        });
                }
            }

            // Gönder butonuna tıklama
            sendButton.addEventListener('click', sendMessage);

            // Enter tuşuna basma
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Sohbet geçmişini temizleme butonu
            const clearChatButton = document.getElementById('clearChatBtn');
            clearChatButton.addEventListener('click', function() {
                if (confirm('Bu sohbeti temizlemek istediğinize emin misiniz?')) {
                    chatMessages.innerHTML = '<div class="no-messages-info"><p>Henüz mesaj yok. Sohbete başlamak için mesaj gönderin.</p></div>';
                }
            });
            
            // Sohbet geçmişini yükleme
            function loadChatHistory(friendId) {
                // Arkadaş ID'sini kaydet
                currentFriendId = friendId;
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '<div class="no-messages-info"><p>Mesajlar yükleniyor...</p></div>';
                
                // Kullanıcı ID'sini al
                const userId = firebase.auth().currentUser.uid;
                
                // Mesajları yükle
                const chatId = [userId, friendId].sort().join('_');
                messagesRef = firebase.database().ref('messages/' + chatId);
                
                // Önce mevcut dinleyiciyi kaldır
                if (messagesRef) {
                    messagesRef.off();
                }
                
                messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                    const messages = snapshot.val();
                    
                    // Mesajlar yoksa bilgi mesajı göster
                    if (!messages) {
                        chatMessages.innerHTML = '<div class="no-messages-info"><p>Henüz mesaj yok. Sohbete başlamak için mesaj gönderin.</p></div>';
                        return;
                    }
                    
                    // Mesajları temizle
                    chatMessages.innerHTML = '';
                    
                    // Mesajları ekle
                    Object.keys(messages).forEach(key => {
                        const message = messages[key];
                        const isUserMessage = message.senderId === userId;
                        
                        // Mesajı deşifre et
                        let messageContent = message.content;
                        if (message.type === 'encrypted') {
                            try {
                                messageContent = atob(message.content); // Base64 decoding
                            } catch (error) {
                                console.error("Mesaj deşifre edilirken hata:", error);
                                messageContent = "Mesaj okunamadı";
                            }
                        }
                        
                        const messageHTML = isUserMessage ? 
                            `<div class="user-message" data-message-id="${key}">
                                <div class="message-content">
                                    <p>${messageContent}</p>
                                </div>
                            </div>` :
                            `<div class="friend-message" data-message-id="${key}">
                                <div class="friend-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="message-content">
                                    <p>${messageContent}</p>
                                </div>
                            </div>`;
                        
                        chatMessages.insertAdjacentHTML('beforeend', messageHTML);
                    });
                    
                    // Sohbeti en alta kaydır (animasyon olmadan)
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Mesajları okundu olarak işaretle
                    markMessagesAsRead(friendId);
                });
            }
            
            // Okunmamış mesajları okundu olarak işaretle
            function markMessagesAsRead(friendId) {
                if (!currentFriendId) return;
                
                const userId = firebase.auth().currentUser.uid;
                const chatId = [userId, friendId].sort().join('_');
                
                // Veritabanındaki tüm mesajları kontrol et
                firebase.database().ref('messages/' + chatId)
                    .orderByChild('senderId')
                    .equalTo(friendId)
                    .once('value')
                    .then((snapshot) => {
                        const messages = snapshot.val();
                        if (!messages) return;
                        
                        // Her bir mesajı okundu olarak işaretle
                        const updates = {};
                        Object.keys(messages).forEach(key => {
                            const message = messages[key];
                            if (!message.read) {
                                updates[key + '/read'] = true;
                            }
                        });
                        
                        // Toplu güncelleme yap
                        if (Object.keys(updates).length > 0) {
                            firebase.database().ref('messages/' + chatId).update(updates)
                                .then(() => {
                                    console.log("Mesajlar okundu olarak işaretlendi");
                                    // Okunmamış mesaj sayısını güncelle
                                    updateUnreadBadge(friendId, 0);
                                })
                                .catch(error => {
                                    console.error("Mesajlar okundu olarak işaretlenirken hata:", error);
                                });
                        }
                    });
            }
            
            // Arkadaş listesindeki okunmamış mesaj sayısını güncelle
            function updateUnreadBadge(friendId, count) {
                const friendItem = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
                if (friendItem) {
                    // Mevcut rozeti kaldır
                    const existingBadge = friendItem.querySelector('.unread-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // Eğer okunmamış mesaj varsa yeni rozet ekle
                    if (count > 0) {
                        friendItem.insertAdjacentHTML('beforeend', `<div class="unread-badge">${count}</div>`);
                    }
                }
            }
            
            // Arkadaş arama işlevi
            const searchInput = document.getElementById('friendSearchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const friendItems = document.querySelectorAll('.friend-item');
                
                friendItems.forEach(item => {
                    const friendName = item.querySelector('.friend-name').textContent.toLowerCase();
                    if (friendName.includes(searchTerm) || searchTerm === '') {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // Bildirim gönderme
            function sendNotification(friendId, message) {
                // Arkadaşın bilgilerini al
                firebase.database().ref('users/' + friendId).once('value')
                    .then((snapshot) => {
                        const friendData = snapshot.val();
                        if (friendData && friendData.notificationToken) {
                            // Bildirim verilerini oluştur
                            const notificationData = {
                                to: friendData.notificationToken,
                                notification: {
                                    title: 'Yeni Mesaj',
                                    body: message.length > 50 ? message.substring(0, 47) + '...' : message,
                                    icon: 'assets/images/logo(192).png',
                                    click_action: window.location.origin + '/messages.html?friend=' + firebase.auth().currentUser.uid
                                }
                            };
                            
                            // Bildirim gönder (Bu kısım backend'de yapılmalı)
                            console.log("Bildirim gönderilecek:", notificationData);
                        }
                    });
            }
            
            // Çevrimiçi durumu güncelleme
            function updateOnlineStatus() {
                // Kullanıcı oturum açmış mı kontrol et
                if (!firebase.auth().currentUser) {
                    console.log("Kullanıcı henüz oturum açmamış, çevrimiçi durumu güncellenemiyor");
                    // Kullanıcı oturum açtığında tekrar dene
                    setTimeout(updateOnlineStatus, 1000);
                    return;
                }
                
                const userId = firebase.auth().currentUser.uid;
                const userStatusRef = firebase.database().ref('status/' + userId);
                
                // Çevrimiçi olduğunda
                firebase.database().ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        // Kullanıcı çıkış yaptığında durumu güncelle
                        userStatusRef.onDisconnect().set({
                            state: 'offline',
                            lastActivity: firebase.database.ServerValue.TIMESTAMP
                        });
                        
                        // Şu anki durumu güncelle
                        userStatusRef.set({
                            state: 'online',
                            lastActivity: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                });
            }
            
            // Çevrimiçi durumu güncellemeyi başlat
            updateOnlineStatus();

            // Okunmamış mesaj sayısını hesaplama ve güncelleme
            function updateUnreadMessageCount(chatId, friendId, userId) {
                firebase.database().ref('messages/' + chatId)
                    .orderByChild('senderId')
                    .equalTo(friendId)
                    .once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            let unreadCount = 0;
                            
                            // Okunmamış mesajları say
                            snapshot.forEach((childSnapshot) => {
                                const message = childSnapshot.val();
                                if (!message.read) {
                                    unreadCount++;
                                }
                            });
                            
                            // Okunmamış mesaj sayısını güncelle
                            updateUnreadBadge(friendId, unreadCount);
                        }
                    })
                    .catch(error => {
                        console.error("Okunmamış mesaj sayısı hesaplanırken hata:", error);
                    });
            }

            // Her saniyede bir son mesajları güncelleme
            function startLastMessageRefresher(userId) {
                console.log("Son mesaj yenileyici başlatılıyor...");
                
                // Global zamanlayıcı değişkeni
                window.lastMessageRefresher = setInterval(function() {
                    console.log("Son mesajlar yenileniyor...");
                    
                    // Tüm arkadaşları al
                    firebase.database().ref('users/' + userId + '/friends').once('value')
                        .then((snapshot) => {
                            const friends = snapshot.val();
                            if (!friends) return;
                            
                            // Her bir arkadaş için son mesajı güncelle
                            Object.keys(friends).forEach(friendId => {
                                const chatId = [userId, friendId].sort().join('_');
                                
                                // Son mesajı bul
                                firebase.database().ref('messages/' + chatId)
                                    .orderByChild('timestamp')
                                    .limitToLast(1)
                                    .once('value')
                                    .then((messageSnapshot) => {
                                        if (messageSnapshot.exists()) {
                                            let lastMessage = null;
                                            
                                            messageSnapshot.forEach((childSnapshot) => {
                                                lastMessage = childSnapshot.val();
                                            });
                                            
                                            if (lastMessage) {
                                                // Mesajı deşifre et
                                                let messageContent = lastMessage.content;
                                                if (lastMessage.type === 'encrypted') {
                                                    try {
                                                        messageContent = atob(lastMessage.content); // Base64 decoding
                                                    } catch (error) {
                                                        console.error("Mesaj deşifre edilirken hata:", error);
                                                        messageContent = "Mesaj okunamadı";
                                                    }
                                                }
                                                
                                                // Son mesajı arkadaş listesinde güncelle
                                                updateLastMessageInFriendsList(friendId, messageContent);
                                                
                                                // Okunmamış mesaj sayısını güncelle
                                                if (lastMessage.senderId === friendId && !lastMessage.read && friendId !== currentFriendId) {
                                                    updateUnreadMessageCount(chatId, friendId, userId);
                                                }
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error("Son mesaj bilgisi yüklenirken hata:", error);
                                    });
                            });
                        })
                        .catch(error => {
                            console.error("Arkadaş listesi yüklenirken hata:", error);
                        });
                }, 1000); // Her 1 saniyede bir yenile
                
                // Sayfa kapatıldığında zamanlayıcıyı temizle
                window.addEventListener('beforeunload', function() {
                    if (window.lastMessageRefresher) {
                        clearInterval(window.lastMessageRefresher);
                    }
                });
            }
        });

        // Sınav türü metni alma fonksiyonu
        function getExamTypeText(examType) {
            switch(examType) {
                case 'tyt': return 'TYT';
                case 'sayisal': return 'Sayısal';
                case 'sozel': return 'Sözel';
                case 'esitagirlik': return 'Eşit Ağırlık';
                case 'dil': return 'Dil';
                default: return 'TYT';
            }
        }
        
        // Arkadaşlar sayfasından mesaj gönderme fonksiyonu
        function sendMessage(friendId) {
            window.location.href = `messages.html?friend=${friendId}`;
        }

        // Son mesajı arkadaş listesinde güncelleme
        function updateLastMessageInFriendsList(friendId, messageContent) {
            const friendItem = document.querySelector(`.friend-item[data-friend-id="${friendId}"]`);
            if (friendItem) {
                const friendInfo = friendItem.querySelector('.friend-info');
                if (friendInfo) {
                    const lastMessageElement = friendInfo.querySelector('.last-message');
                    if (lastMessageElement) {
                        // Son mesaj elementi varsa içeriğini güncelle
                        lastMessageElement.textContent = messageContent;
                    } else {
                        // Son mesaj elementi yoksa yeni bir element ekle
                        friendInfo.insertAdjacentHTML('beforeend', `<p class="last-message">${messageContent}</p>`);
                    }
                }
            }
        }
    </script>
</body>
</html> 